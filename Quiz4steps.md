## 编写智能合约的注意点

0. 确定每个业务的逻辑，确定业务角色

- 信用证包括哪些属性？
- 业务模式里包括哪些参与方？
- 不同参与方会有哪些业务流（workflow）？
- 不同参与方的权限有什么异同？

1. 思考大的设计模式：工厂？表？数据逻辑分离？

- 工厂模式的好处：同质化产品，又有一定复杂度（如存证、凭证）的生成和管理
- 表：同质化产品，但只需要简单的数据CRUD
- 数据逻辑分离：在复杂多变的数据存取模型中是必须的

2. 设计数据结构和接口

- 属性里面，哪些是必须上链的，哪些不能上链？
- 工厂模式里，不是必须，不要用struct
- 各种状态和标志位可以随用随加
- 工厂模式里，和产品相关的CRUD接口放在产品里，和产品生产/删除相关的接口放在工厂里

3. 设计主要逻辑
- 工厂：创建和拆分
- 信用证本身：创建、读取、设置状态、信用证转移、额度消耗

4. 细化业务逻辑
- 按照Checks-Effects-Interaction的方式强化合约安全
    - 先做入参检查和业务检查
    - 再做内部状态变更
    - 再做合约间调用
    - 有任何错误就revert
- 用一些更优的第三方库来代替常见功能

5. 是否需要重构：更强化的分离？合约代理，合约注册表，合约权限？

6. 其他细节优化

## 在Remix中编译、部署测试

1. 编译合约

2. 部署

3. 更换角色，调用相关函数并观察返回值和log

4. 测试步骤
- 创建A，B，C，D三个角色，分别为发证人，持有者1，持有者2，承兑方
- 通过工厂，让A给B发一个信用证
- 让A批准这个信用证
- 让A将这个信用证拆分成两个额度只有之前一半的给到B
- B将其中一个信用证给到C
- 查看C的信用证流转记录
- 最后由D设置B和C的两个信用证为已支付